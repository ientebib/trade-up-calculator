<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade-Up Value Creation Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 36px;
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(135deg, #00ff88, #00aaff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #111;
            border: 1px solid #222;
            padding: 25px;
            border-radius: 12px;
        }
        
        h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #00ff88;
        }
        
        .input-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            font-size: 15px;
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .calculated-field {
            background: #0d1117;
            border: 1px solid #00ff88;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .calculated-label {
            font-size: 11px;
            color: #00ff88;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .calculated-value {
            font-size: 24px;
            font-weight: 700;
            color: #00ff88;
        }
        
        .value-creation-section {
            background: linear-gradient(135deg, #0d1117, #161b22);
            border: 2px solid #00ff88;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .flow-diagram {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto 1fr;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .flow-box {
            text-align: center;
            padding: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .flow-box.highlight {
            border-color: #00ff88;
            background: rgba(0,255,136,0.1);
        }
        
        .flow-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .flow-value {
            font-size: 28px;
            font-weight: 700;
        }
        
        .flow-arrow {
            font-size: 24px;
            color: #00ff88;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-card {
            background: #111;
            border: 1px solid #222;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }
        
        .result-card.primary {
            border-color: #00ff88;
            background: rgba(0,255,136,0.05);
        }
        
        .result-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .result-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .result-detail {
            font-size: 13px;
            color: #666;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #1a1a1a;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
        }
        
        .breakdown-label {
            color: #666;
            font-size: 14px;
        }
        
        .breakdown-value {
            font-weight: 600;
            font-size: 14px;
        }
        
        .positive {
            color: #00ff88;
        }
        
        .negative {
            color: #ff4444;
        }
        
        .info-box {
            background: rgba(0,170,255,0.1);
            border: 1px solid rgba(0,170,255,0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            color: #00aaff;
        }
        
        .tab-navigation {
            display: flex;
            background: #111;
            border-radius: 12px;
            padding: 8px;
            gap: 4px;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: transparent;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
        }
        
        .tab:hover {
            background: #1a1a1a;
            color: #999;
        }
        
        .tab.active {
            background: #4a9eff;
            color: #000;
            font-weight: 600;
        }
        
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* Matrix-specific styles */
        .matrix-input {
            width: 100px; /* wider to accommodate larger numbers */
            padding: 4px;
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #333;
            border-radius: 4px;
            text-align: right;
            font-size: 12px;
        }
        
        .matrix-input:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .matrix-checkbox {
            margin-left: 4px;
        }
        
        .matrix-config-panel {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none; /* Hidden by default */
        }
        .matrix-config-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #4a9eff;
            font-size: 16px;
        }
        .matrix-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }
        .matrix-config-item {
            display: flex;
            align-items: center;
            background: #111;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        .matrix-config-item input {
            margin-right: 10px;
        }
        
        .current-term-col {
            background: rgba(74, 158, 255, 0.1) !important;
            border-left: 2px solid #4a9eff !important;
            border-right: 2px solid #4a9eff !important;
        }

        .matrix-view-controls {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        .matrix-view-controls button {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s ease;
        }
        .matrix-view-controls button:hover {
            background: #444;
        }
        .matrix-view-controls button.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }
        .matrix-view-controls .matrix-config-item { /* For the new toggle */
            margin-right: auto;
            background: transparent;
            padding: 0;
            align-self: center;
        }
        .matrix-view-controls .matrix-config-item label {
            color: #fff;
            font-size: 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trade-Up Value Creation Calculator</h1>
        <p class="subtitle">Understanding how term extension creates massive value to share</p>
        
        <!-- Navigation Tabs -->
        <div class="tab-navigation" style="margin-bottom: 25px;">
            <div class="tab active" onclick="showPage('inputs')" id="inputsTab">🚗 Deal Inputs</div>
            <div class="tab" onclick="showPage('analytics')" id="analyticsTab">📈 P&L Analytics</div>
            <div class="tab" onclick="showPage('planMatrix')" id="planMatrixTab">📊 Plan Matrix</div>
            <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                <div id="mainSaveStatus" style="font-size: 11px; color: #00ff88; padding: 4px 8px; background: rgba(0,255,136,0.1); border-radius: 4px; border: 1px solid rgba(0,255,136,0.3);">
                    Auto-save enabled ✓
                </div>
                <button onclick="calculate()" style="background: #ff9900; color: #000; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">🔄 Recalculate</button>
                <button onclick="exportToCSV()" style="background: #4a9eff; color: #000; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">📊 Export CSV</button>
                <button onclick="saveData(true, event)" style="background: #00ff88; color: #000; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">💾 Save Data</button>
            </div>
        </div>
        
        <!-- Page: Deal Inputs -->
        <div id="inputsPage" class="page-content active">
        <div class="card" style="margin-bottom: 25px; background: linear-gradient(135deg, #1a1a1a, #0d1117); border: 2px solid #4a9eff;">
            <h2 style="color: #4a9eff;">🚗 Vehicle Trading Margin</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; align-items: end;">
                <div class="input-group">
                    <label>Vehicle Purchase Price</label>
                    <input type="number" id="purchasePrice" value="22000" oninput="calculateWithAutoSave()" style="background: #0d1117; border-color: #4a9eff;">
                </div>
                <div class="input-group">
                    <label>Vehicle Sale Price</label>
                    <input type="number" id="salePrice" value="28000" oninput="syncNewPrice(); calculateWithAutoSave();" style="background: #0d1117; border-color: #4a9eff;">
                </div>
                <div class="calculated-field" style="border-color: #4a9eff; background: rgba(74,158,255,0.1);">
                    <div class="calculated-label" style="color: #4a9eff;">Gross Margin</div>
                    <div class="calculated-value" style="color: #4a9eff;" id="grossMargin">$6,000</div>
                </div>
                <div class="calculated-field" style="border-color: #4a9eff; background: rgba(74,158,255,0.1);">
                    <div class="calculated-label" style="color: #4a9eff;">Margin %</div>
                    <div class="calculated-value" style="color: #4a9eff;" id="marginPercent">27.3%</div>
                </div>
            </div>
        </div>
        
        <div class="main-grid">
            <div class="card">
                <h2>📊 Current Loan Details</h2>
                <div class="input-group">
                    <label>Original Loan Amount</label>
                    <input type="number" id="originalAmount" value="25000" oninput="calculateWithAutoSave()">
                </div>
                <div class="input-group">
                    <label>Original Term (months)</label>
                    <input type="number" id="originalTerm" value="60" oninput="calculateWithAutoSave()">
                </div>
                <div class="input-group">
                    <label>Interest Rate (%)</label>
                    <input type="number" id="currentRate" value="9.5" step="0.1" oninput="calculateWithAutoSave()">
                </div>
                <div class="input-group">
                    <label>Discount Rate for NPV (%)</label>
                    <input type="number" id="discountRate" value="10" step="0.1" oninput="calculateWithAutoSave()">
                </div>
                <div class="input-group">
                    <label>Months Left on Current Loan</label>
                    <input type="number" id="monthsLeft" value="30" oninput="calculateWithAutoSave()">
                </div>
                <div class="input-group">
                    <label>Current Car Value</label>
                    <input type="number" id="currentValue" value="18000" oninput="calculateWithAutoSave()">
                </div>
                <div class="input-group">
                    <label><input type="checkbox" id="baselineToggle" onchange="calculateWithAutoSave()" style="margin-right:6px;">Show gross payment (with IVA+GPS)</label>
                </div>
                
                <div class="calculated-field">
                    <div class="calculated-label">Current Monthly Payment</div>
                    <div class="calculated-value" id="monthlyPayment">$525</div>
                </div>
                
                <div class="calculated-field">
                    <div class="calculated-label">Current Balance</div>
                    <div class="calculated-value" id="currentBalance">$13,125</div>
                </div>
                
                <div class="calculated-field">
                    <div class="calculated-label">Customer Equity</div>
                    <div class="calculated-value" id="equity">$4,875</div>
                </div>
            </div>
            
            <div class="card">
                <h2>🚗 New Vehicle Terms</h2>
                <div class="input-group">
                    <label>New Car Price</label>
                    <input type="number" id="newPrice" value="28000" oninput="syncSalePrice(); calculateWithAutoSave();" style="background: rgba(74,158,255,0.1); border-color: #4a9eff;">
                </div>
                <div class="input-group">
                    <label>New Loan Term</label>
                    <select id="newTerm" onchange="calculateWithAutoSave()">
                        <option value="12">12 months</option>
                        <option value="24">24 months</option>
                        <option value="36">36 months</option>
                        <option value="48">48 months</option>
                        <option value="60" selected>60 months</option>
                        <option value="72">72 months</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Market Interest Rate (%)</label>
                    <input type="number" id="marketRate" value="13.5" step="0.1" oninput="calculateWithAutoSave()">
                </div>
                <div class="input-group">
                    <label>Your Cost of Funds (%)</label>
                    <input type="number" id="costOfFunds" value="7.5" step="0.1" oninput="calculateWithAutoSave()">
                </div>
                <div class="input-group">
                    <label><input type="checkbox" id="downPaymentToggle" onchange="toggleDownPayment(); calculateWithAutoSave();" style="margin-right:6px;">Customer Down Payment (%)</label>
                    <input type="number" id="downPaymentPct" value="10" step="1" min="0" max="30" oninput="calculateWithAutoSave()" style="opacity: 0.5;" disabled>
                </div>
                <div class="input-group">
                    <label>Origination Fee (%)</label>
                    <input type="number" id="originationPct" value="1.0" step="0.1" oninput="calculateWithAutoSave()">
                    <div style="margin-top:6px; display: flex; justify-content: space-between;">
                        <label><input type="checkbox" id="originationFinance" onchange="calculateWithAutoSave()" style="margin-right:4px;" checked>Finance</label>
                        <label><input type="checkbox" id="originationIvaToggle" onchange="calculateWithAutoSave()" style="margin-right:4px;" checked>Apply IVA</label>
                    </div>
                </div>
                <div class="input-group">
                    <label>Service Fee (%)</label>
                    <input type="number" id="servicePct" value="1.0" step="0.1" oninput="calculateWithAutoSave()">
                    <div style="margin-top:6px; display: flex; justify-content: space-between;">
                        <label><input type="checkbox" id="serviceFinance" onchange="calculateWithAutoSave()" style="margin-right:4px;" checked>Finance</label>
                        <label><input type="checkbox" id="serviceIvaToggle" onchange="calculateWithAutoSave()" style="margin-right:4px;" checked>Apply IVA</label>
                    </div>
                </div>
                <div class="input-group">
                    <label><input type="checkbox" id="ivaToggle" onchange="calculateWithAutoSave()" style="margin-right:6px;" checked>Apply IVA to Interest Rate</label>
                </div>
                <div class="input-group">
                    <label><input type="checkbox" id="kavakToggle" onchange="calculateWithAutoSave()" style="margin-right:6px;">Kavak Total ($)</label>
                    <input type="number" id="kavakAmount" value="600" step="50" oninput="calculateWithAutoSave()">
                    <div style="margin-top:6px; display: flex; justify-content: space-between;">
                        <label><input type="checkbox" id="kavakFinance" onchange="calculateWithAutoSave()" style="margin-right:4px;">Finance</label>
                        <label><input type="checkbox" id="kavakIvaToggle" onchange="calculateWithAutoSave()" style="margin-right:4px;" checked>Apply IVA</label>
                    </div>
                </div>
                <div class="input-group">
                    <label><input type="checkbox" id="maintToggle" onchange="calculateWithAutoSave()" style="margin-right:6px;">Maintenance Plan ($)</label>
                    <input type="number" id="maintAmount" value="400" step="50" oninput="calculateWithAutoSave()">
                    <div style="margin-top:6px; display: flex; justify-content: space-between;">
                        <label><input type="checkbox" id="maintFinance" onchange="calculateWithAutoSave()" style="margin-right:4px;">Finance</label>
                        <label><input type="checkbox" id="maintIvaToggle" onchange="calculateWithAutoSave()" style="margin-right:4px;" checked>Apply IVA</label>
                    </div>
                </div>
                <div class="input-group">
                    <label>Mandatory Yearly Insurance (Financed)</label>
                    <div id="mandatoryInsuranceDisplay" style="font-size: 18px; color: #fff; padding: 8px 0;">$10,999</div>
                    <div style="margin-top:6px;">
                        <label><input type="checkbox" id="insuranceIvaToggle" onchange="calculateWithAutoSave()" style="margin-right:4px;" checked>Apply IVA</label>
                    </div>
                </div>
                
                <div class="calculated-field">
                    <div class="calculated-label">Loan Amount Needed</div>
                    <div class="calculated-value" id="loanNeeded">$23,125</div>
                </div>
                
                <div class="calculated-field" id="customerCashField" style="display: none;">
                    <div class="calculated-label" style="color: #4a9eff;">Customer Cash Required</div>
                    <div class="calculated-value" style="color: #4a9eff;" id="customerCashRequired">$0</div>
                </div>
                
                <div class="calculated-field">
                    <div class="calculated-label">Total Monthly Payment</div>
                    <div class="calculated-value" id="marketPayment">$929</div>
                </div>
                
                <div class="info-box">
                    💡 Payment change: <span id="paymentChange">+$4</span>
                </div>
            </div>
        </div>
        
        <!-- Value Creation Visualization -->
        <div class="value-creation-section" style="margin-top: 30px;">
            <h2 style="text-align: center; margin-bottom: 20px;">💰 Value Creation Through Term Extension</h2>
            
            <div class="flow-diagram">
                <div class="flow-box">
                    <div class="flow-label">Current NPV</div>
                    <div class="flow-value" id="currentNPV">$1,500</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;" id="currentMonthsLeft">30 months left</div>
                </div>
                <div class="flow-arrow">→</div>
                <div class="flow-box">
                    <div class="flow-label">New Loan NPV</div>
                    <div class="flow-value" id="newNPV">$6,938</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;" id="newTermDisplay">60 months</div>
                </div>
                <div class="flow-arrow">=</div>
                <div class="flow-box highlight">
                    <div class="flow-label">VALUE CREATED</div>
                    <div class="flow-value" style="color: #00ff88;" id="valueCreated">$5,438</div>
                    <div style="font-size: 11px; color: #00ff88; margin-top: 5px;">Pure profit!</div>
                </div>
            </div>
            
            <div style="text-align: center; color: #999; font-size: 14px; margin-top: 20px;">
                By extending the term, you create <strong style="color: #00ff88;" id="valueCreatedText">$5,438</strong> in additional profit opportunity
            </div>
        </div>
        
        <!-- Customer Lifetime Value -->
        <div class="value-creation-section" style="border: 2px solid #00aaff; margin-top: 20px;">
            <h2 style="text-align: center; margin-bottom: 20px; color: #00aaff;">📈 Customer Lifetime Value</h2>
            
            <div class="flow-diagram">
                <div class="flow-box">
                    <div class="flow-label">Historical NPV</div>
                    <div class="flow-value" id="historicalNPV" style="color: #00aaff;">$2,450</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">From original loan</div>
            </div>
                <div class="flow-arrow">+</div>
                <div class="flow-box">
                    <div class="flow-label">New Deal NPV</div>
                    <div class="flow-value" id="newDealNPV" style="color: #00aaff;">$3,807</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">This transaction</div>
                    </div>
                <div class="flow-arrow">=</div>
                <div class="flow-box highlight" style="border-color: #00aaff; background: rgba(0,170,255,0.1);">
                    <div class="flow-label">TOTAL LTV</div>
                    <div class="flow-value" style="color: #00aaff;" id="totalLTV">$6,257</div>
                    <div style="font-size: 11px; color: #00aaff; margin-top: 5px;">Customer value!</div>
                </div>
            </div>
            
            <div style="text-align: center; color: #999; font-size: 14px; margin-top: 20px;">
                This customer's total lifetime value: <strong style="color: #00aaff;" id="ltvText">$6,257</strong>
                </div>
            </div>
            
        <!-- Deal Results -->
        <div class="results-grid" style="margin-top: 30px;">
            <div class="result-card">
                <div class="result-label">New Monthly Payment</div>
                <div class="result-value positive" id="finalPayment">$878</div>
                <div class="result-detail" id="paymentComparison">vs $925 current</div>
            </div>
            <div class="result-card primary">
                <div class="result-label">Your Net Profit (NPV)</div>
                <div class="result-value positive" id="yourProfit">$3,807</div>
                <div class="result-detail">Total profit from deal</div>
            </div>
            <div class="result-card">
                <div class="result-label">Customer Saves</div>
                <div class="result-value positive" id="customerSaves">$47/mo</div>
                <div class="result-detail">Lower payment + newer car!</div>
            </div>
        </div>
        
        </div> <!-- End inputs page -->

        
        <!-- Page: P&L Analytics -->
        <div id="analyticsPage" class="page-content">
        <div class="card" style="margin-bottom: 30px;">
                <h2>💰 Deal Profit & Loss Analysis (NPV Basis)</h2>
                
                <!-- Operating Profit -->
                <div class="breakdown-item" style="background: rgba(74,158,255,0.1); padding: 15px; border-radius: 8px 8px 0 0; margin-bottom: 0; border-bottom: 2px solid rgba(74,158,255,0.2);">
                    <span class="breakdown-label" style="font-size: 16px; font-weight: 700; color: #4a9eff;">I. Operating Profit</span>
                    <span class="breakdown-value positive" style="font-size: 18px;" id="pl_op_total">$0</span>
            </div>
                <div style="background: #0a0a0a; padding: 10px 20px; border-radius: 0 0 8px 8px; margin-bottom: 20px; font-size: 13px; color: #bbb;">
                    <div style="display: flex; justify-content: space-between; padding: 5px 0;"><span>Vehicle Trading Margin</span><span id="pl_op_trading" class="positive">+ $0</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 5px 0;"><span>Fee Revenue</span><span id="pl_op_fees" class="positive">+ $0</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 5px 0;"><span>Add-on Revenue</span><span id="pl_op_addons" class="positive">+ $0</span></div>
            </div>
            
                <!-- Financing Profit (NPV) -->
                <div class="breakdown-item" style="background: rgba(74,158,255,0.1); padding: 15px; border-radius: 8px 8px 0 0; margin-bottom: 0; border-bottom: 2px solid rgba(74,158,255,0.2);">
                    <span class="breakdown-label" style="font-size: 16px; font-weight: 700; color: #4a9eff;">II. Financing Profit (Net Present Value)</span>
                    <span class="breakdown-value positive" style="font-size: 18px;" id="pl_fin_total">$0</span>
            </div>
                <div style="background: #0a0a0a; padding: 10px 20px; border-radius: 0 0 8px 8px; margin-bottom: 20px; font-size: 13px; color: #bbb;">
                    <div style="display: flex; justify-content: space-between; padding: 5px 0;"><span>Net Interest Margin (NPV)</span><span id="pl_fin_nim" class="positive">+ $0</span></div>
            </div>
            
                <!-- Total Profit -->
                <div class="breakdown-item" style="background: rgba(0,255,136,0.2); padding: 20px; border-radius: 8px; margin-top: 20px; border: 2px solid #00ff88;">
                    <span class="breakdown-label" style="font-size: 18px; font-weight: 700; color: #00ff88;">TOTAL DEAL PROFIT (NPV)</span>
                    <span class="breakdown-value positive" style="font-size: 24px; color: #00ff88;" id="pl_total_final">$0</span>
            </div>
            </div>
            </div>
        
        <!-- Page: Plan Matrix -->
        <div id="planMatrixPage" class="page-content">
        
        <div class="card" style="margin-bottom: 25px; background: linear-gradient(135deg, #1a1a1a, #0d1117); border: 2px solid #4a9eff;">
            <h2 style="color: #4a9eff; margin-bottom: 20px;">📊 Loan Term Comparison Matrix</h2>
            
            <div class="matrix-view-controls">
                <div class="matrix-config-item">
                    <input type="checkbox" id="equalizeTermsToggle" onchange="handleEqualizeToggle(this.checked)">
                    <label for="equalizeTermsToggle">Equalize All Terms</label>
                </div>
                <button onclick="applyMatrixView('client')" id="clientViewBtn">Client View</button>
                <button onclick="applyMatrixView('default')" id="defaultViewBtn">Default View</button>
                <button onclick="toggleMatrixConfig()" id="configViewBtn">⚙️ Configure View</button>
            </div>

            <div id="matrixConfigPanel" class="matrix-config-panel">
                <h3>Show/Hide Matrix Rows</h3>
                <div id="matrixConfigGrid" class="matrix-config-grid"></div>
            </div>
            
            <!-- The Matrix Grid -->
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: #0d1117;">
                            <th style="padding: 15px; text-align: left; border: 1px solid #333; color: #999; position: sticky; left: 0; background: #0d1117; z-index: 10;">METRICS</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #333; color: #4a9eff;">12 MONTHS</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #333; color: #4a9eff;">24 MONTHS</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #333; color: #4a9eff;">36 MONTHS</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #333; color: #4a9eff;">48 MONTHS</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #333; color: #4a9eff;">60 MONTHS</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #333; color: #4a9eff;">72 MONTHS</th>
                        </tr>
                    </thead>
                    <tbody id="planMatrixBody"></tbody>
                </table>
            </div>
        </div>
        
        </div> <!-- End plan matrix page -->
    </div>
    
    <script>
        // Constants for VAT (IVA) and GPS recurring charge
        const IVA_RATE = 0.16;           // 16% VAT applied to interest and GPS
        const GPS_MONTHLY = 350;         // MXN monthly GPS fee (before VAT)
        const MANDATORY_INSURANCE_YEARLY = 10999; // Yearly mandatory insurance cost
        
        // Per-term settings
        const downOverrides = {};
        const columnSettings = {};
        
        // --- State for Matrix Row Visibility ---
        const matrixViewConfig = {
            // Added per user request
            'newCarPrice': { label: 'Vehicle Price', visible: true },
            'enganche': { label: 'Equity / Trade-in', visible: true },
            
            // Editable Inputs
            'downPaymentPct': { label: 'Down Payment %', visible: true },
            'downPaymentAmount': { label: 'Down Payment', visible: true },
            'loanAmount': { label: 'Total Loan Amount', visible: true, isHeader: true },
            'originationFeePct': { label: 'Origination Fee %', visible: true },
            'serviceFeePct': { label: 'Service Fee %', visible: true },
            'kavak': { label: 'Kavak Total $', visible: true },
            'maint': { label: 'Maintenance Plan $', visible: true },
            // P&L Breakdown
            'vehiclePayment': { label: 'Vehicle Payment', visible: true, isHeader: true },
            'insurancePayment': { label: '+ Financed Insurance', visible: true, isIndented: true },
            'gpsMonthly': { label: '+ GPS (IVA incl.)', visible: true, isIndented: true },
            'mensualidad1': { label: 'Mensualidad (Base)', visible: true },
            'serviceFeePayment': { label: '+ Financed Service Fee', visible: true, isIndented: true },
            'origFeePayment': { label: '+ Financed Origination Fee', visible: true, isIndented: true },
            'mensualidad2': { label: 'Mensualidad (Fees)', visible: true },
            'kavakPayment': { label: '+ Financed Kavak', visible: true, isIndented: true },
            'maintPayment': { label: '+ Financed Maintenance', visible: true, isIndented: true },
            'totalMonthlyPayment': { label: 'Mensualidad (All In)', visible: true }, 
            // Cash Required Breakdown
            'cashRequiredTotal': { label: 'Total Cash Required', visible: true, isHeader: true },
            'cashRequiredDownPayment': { label: '→ from Down Payment', visible: true, isIndented: true },
            'cashRequiredFees': { label: '→ for Upfront Fees', visible: true, isIndented: true },
            'cashRequiredAddons': { label: '→ for Upfront Add-ons', visible: true, isIndented: true },
            // Summary
            'npvCreated': { label: 'NPV Created', visible: true },
        };
        const matrixRowOrder = [
            'newCarPrice', 'enganche',
            'downPaymentPct',
            'downPaymentAmount',
            'cashRequiredTotal', 'cashRequiredDownPayment', 'cashRequiredFees', 'cashRequiredAddons',
            'loanAmount',
            'originationFeePct', 'serviceFeePct', 'kavak', 'maint',
            'vehiclePayment', 'insurancePayment', 'gpsMonthly', 'mensualidad1',
            'serviceFeePayment', 'origFeePayment', 'mensualidad2',
            'kavakPayment', 'maintPayment', 'totalMonthlyPayment',
            'npvCreated'
        ];

        const clientViewRows = [
            'newCarPrice', 'enganche',
            'downPaymentAmount',
            'cashRequiredTotal', 'cashRequiredDownPayment', 'cashRequiredFees', 'cashRequiredAddons',
            'loanAmount',
            'vehiclePayment', 'insurancePayment', 'gpsMonthly', 'mensualidad1',
            'serviceFeePayment', 'origFeePayment', 'mensualidad2',
            'kavakPayment', 'maintPayment', 'totalMonthlyPayment',
        ];
        
        // Terms array
        const termsArray = [12, 24, 36, 48, 60, 72];
        
        // Populate downOverrides & columnSettings from Deal-Inputs (called on page load)
        function syncFromInputs() {
            const baseOrigPct = parseFloat(document.getElementById('originationPct').value) / 100 || 0;
            const baseServPct = parseFloat(document.getElementById('servicePct').value) / 100 || 0;
            const baseDownPct = (document.getElementById('downPaymentToggle').checked ? parseFloat(document.getElementById('downPaymentPct').value) : 0) / 100 || 0;

            const kavakToggle = document.getElementById('kavakToggle').checked;
            const maintToggle = document.getElementById('maintToggle').checked;
            const vehInsToggle = true; // Always on

            const kavakAmt = kavakToggle ? (parseFloat(document.getElementById('kavakAmount').value) || 0) : 0;
            const maintAmt = maintToggle ? (parseFloat(document.getElementById('maintAmount').value) || 0) : 0;
            const vehInsAmt = MANDATORY_INSURANCE_YEARLY * (parseInt(document.getElementById('newTerm').value) / 12); // Total for term

            const kavakFin = kavakToggle && document.getElementById('kavakFinance').checked;
            const maintFin = maintToggle && document.getElementById('maintFinance').checked;
            const vehInsFin = true; // Always financed

            termsArray.forEach(term => {
                if (!(term in downOverrides)) downOverrides[term] = baseDownPct;
                if (!(term in columnSettings)) {
                    columnSettings[term] = {
                        origPct: baseOrigPct,
                        servicePct: baseServPct,
                        kavak: { amount: kavakAmt, finance: kavakFin },
                        maint: { amount: maintAmt, finance: maintFin },
                        vehIns: { amount: vehInsAmt, finance: vehInsFin }
                    };
                }
            });
        }
        
        // Push settings of a particular term back into Deal-Inputs (only if that term currently selected)
        function syncToInputs(term) {
            const currentTermSel = parseInt(document.getElementById('newTerm').value);
            if (term !== currentTermSel) return;

            // Down payment
            const dpPct = (downOverrides[term] || 0) * 100;
            if (dpPct > 0) {
                document.getElementById('downPaymentToggle').checked = true;
                document.getElementById('downPaymentPct').disabled = false;
                document.getElementById('downPaymentPct').style.opacity = '1';
            }
            document.getElementById('downPaymentPct').value = dpPct.toFixed(1);

            const cfg = columnSettings[term];
            document.getElementById('originationPct').value = (cfg.origPct * 100).toFixed(1);
            document.getElementById('servicePct').value = (cfg.servicePct * 100).toFixed(1);

            // Kavak
            document.getElementById('kavakToggle').checked = cfg.kavak.amount > 0;
            document.getElementById('kavakAmount').value = cfg.kavak.amount;
            document.getElementById('kavakFinance').checked = cfg.kavak.finance;

            // Maintenance
            document.getElementById('maintToggle').checked = cfg.maint.amount > 0;
            document.getElementById('maintAmount').value = cfg.maint.amount;
            document.getElementById('maintFinance').checked = cfg.maint.finance;

            // Vehicle insurance is now fixed
            // document.getElementById('vehicleInsToggle').checked = cfg.vehIns.amount > 0;
            // document.getElementById('vehicleInsAmount').value = cfg.vehIns.amount;
            // document.getElementById('vehicleInsFinance').checked = cfg.vehIns.finance;

            // Trigger recalculation
            calculateWithAutoSave();
        }
        
        function toggleDownPayment() {
            const toggle = document.getElementById('downPaymentToggle');
            const input = document.getElementById('downPaymentPct');
            if (toggle.checked) {
                input.disabled = false;
                input.style.opacity = '1';
            } else {
                input.disabled = true;
                input.style.opacity = '0.5';
            }
        }
        
        function calculateMonthlyPayment(principal, annualRate, months) {
            const r = annualRate / 12;
            if (r === 0) return principal / months;
            return principal * r * Math.pow(1 + r, months) / (Math.pow(1 + r, months) - 1);
        }
        
        function calculateBalance(originalPrincipal, annualRate, originalTerm, paymentsMade) {
            const r = annualRate / 12;
            const payment = calculateMonthlyPayment(originalPrincipal, annualRate, originalTerm);
            
            let balance = originalPrincipal;
            for (let i = 0; i < paymentsMade; i++) {
                const interest = balance * r;
                const principal = payment - interest;
                balance -= principal;
            }
            
            return balance;
        }
        
        function calculateNPV(principal, annualRate, costOfFunds, months, discountRate = 0.10) {
            const payment = calculateMonthlyPayment(principal, annualRate, months);
            let balance = principal;
            let grossYieldNPV = 0;
            let costOfFundsNPV = 0;

            if (principal <= 0 || months <= 0) {
                return { grossYieldNPV: 0, costOfFundsNPV: 0, netMarginNPV: 0 };
            }

            for (let i = 1; i <= months; i++) {
                const discFactor = Math.pow(1 + discountRate / 12, i);
                
                const grossInterestComponent = balance * (annualRate / 12);
                grossYieldNPV += grossInterestComponent / discFactor;
                
                const costOfFundsComponent = balance * (costOfFunds / 12);
                costOfFundsNPV += costOfFundsComponent / discFactor;
                
                const principalPayment = payment - grossInterestComponent;
                balance -= principalPayment;
            }
            
            return {
                grossYieldNPV,
                costOfFundsNPV,
                netMarginNPV: grossYieldNPV - costOfFundsNPV
            };
        }
        
        function formatCurrency(amount) {
            if (isNaN(amount) || amount === null || amount === undefined) {
                return '$0';
            }
            return '$' + Math.round(amount).toLocaleString();
        }
        
        function formatPercent(rate) {
            return (rate * 100).toFixed(1) + '%';
        }
        
        function calculate() {
            try {
                // Get current loan inputs
                const originalAmount = parseFloat(document.getElementById('originalAmount').value) || 0;
                const originalTerm = parseFloat(document.getElementById('originalTerm').value) || 60;
                const currentRate = parseFloat(document.getElementById('currentRate').value) / 100 || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) / 100 || 0;
                const monthsLeft = parseFloat(document.getElementById('monthsLeft').value) || 0;
                const currentValue = parseFloat(document.getElementById('currentValue').value) || 0;
                
                // Calculate current loan details
                const monthlyPaymentBase = calculateMonthlyPayment(originalAmount, currentRate, originalTerm);
                const monthsPaid = originalTerm - monthsLeft;
                const currentBalance = calculateBalance(originalAmount, currentRate, originalTerm, monthsPaid);
                const equity = currentValue - currentBalance;
                
                // Calculate current total payment based on baseline toggle
                const baselineIncludesIVA = document.getElementById('baselineToggle').checked;
                let currentTotalPayment;
                if (baselineIncludesIVA) {
                    // checked → show gross (net amort + IVA on interest + GPS w/ IVA)
                    const currentInterestPortion = currentBalance * (currentRate / 12);
                    const currentIVA = currentInterestPortion * IVA_RATE;
                    const gpsWithIVA = GPS_MONTHLY * (1 + IVA_RATE);
                    currentTotalPayment = monthlyPaymentBase + currentIVA + gpsWithIVA;
                } else {
                    // unchecked → pure amortization-only
                    currentTotalPayment = monthlyPaymentBase;
                }
                
                // Display current loan calculations
                document.getElementById('monthlyPayment').textContent = formatCurrency(currentTotalPayment);
                document.getElementById('currentBalance').textContent = formatCurrency(currentBalance);
                document.getElementById('equity').textContent = formatCurrency(equity);
                
                // Get new loan inputs
                const newPrice = parseFloat(document.getElementById('newPrice').value) || 0;
                const newTerm = parseFloat(document.getElementById('newTerm').value) || 60;
                let marketRate = parseFloat(document.getElementById('marketRate').value) / 100 || 0;
                if (newTerm === 60) {
                    marketRate += 0.01;
                } else if (newTerm === 72) {
                    marketRate += 0.015;
                }
                const costOfFunds = parseFloat(document.getElementById('costOfFunds').value) / 100 || 0;
                const downPaymentToggle = document.getElementById('downPaymentToggle').checked;
                const downPaymentPct = downPaymentToggle ? (parseFloat(document.getElementById('downPaymentPct').value) / 100 || 0) : 0;
                const originationPct = parseFloat(document.getElementById('originationPct').value) / 100 || 0;
                const servicePct = parseFloat(document.getElementById('servicePct').value) / 100 || 0;
                
                // Add-ons
                const kavakIncluded = document.getElementById('kavakToggle').checked;
                const kavakAmount = kavakIncluded ? (parseFloat(document.getElementById('kavakAmount').value) || 0) : 0;
                const kavakFinanced = kavakIncluded && document.getElementById('kavakFinance').checked;

                const maintIncluded = document.getElementById('maintToggle').checked;
                const maintAmount = maintIncluded ? (parseFloat(document.getElementById('maintAmount').value) || 0) : 0;
                const maintFinanced = maintIncluded && document.getElementById('maintFinance').checked;
                
                // Fee financing toggles
                const originationFinanced = document.getElementById('originationFinance').checked;
                const serviceFinanced = document.getElementById('serviceFinance').checked;

                // Granular IVA Toggles
                const rateIvaOn = document.getElementById('ivaToggle').checked;
                const originationIva = document.getElementById('originationIvaToggle').checked;
                const serviceIva = document.getElementById('serviceIvaToggle').checked;
                const kavakIva = document.getElementById('kavakIvaToggle').checked;
                const maintIva = document.getElementById('maintIvaToggle').checked;
                const insuranceIva = document.getElementById('insuranceIvaToggle').checked;
                
                const rateMultiplier = rateIvaOn ? (1 + IVA_RATE) : 1;
                
                // Car margin calculations
                const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
                const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
                const grossMargin = salePrice - purchasePrice;
                const marginPercent = purchasePrice > 0 ? (grossMargin / purchasePrice) * 100 : 0;
                
                // Display car margin calculations
                document.getElementById('grossMargin').textContent = formatCurrency(grossMargin);
                document.getElementById('marginPercent').textContent = marginPercent.toFixed(1) + '%';
                
                // --- Calculate new loan details (Reworked for financing and granular IVA toggles) ---
                let baseLoan = newPrice - equity - (newPrice * downPaymentPct);
                if (baseLoan < 0) baseLoan = 0;

                // Service Fee
                const serviceFeeBase = newPrice * servicePct;
                const serviceFeeMultiplier = serviceIva ? (1 + IVA_RATE) : 1;
                const serviceFeeGross = serviceFeeBase * serviceFeeMultiplier;
                const serviceFeeToFinance = serviceFinanced ? serviceFeeGross : 0;
                const serviceFeeUpfront = serviceFinanced ? 0 : serviceFeeGross;

                // Addons (Kavak, Maint, Insurance)
                const kavakMultiplier = kavakIva ? (1 + IVA_RATE) : 1;
                const kavakGross = kavakAmount * kavakMultiplier;
                const kavakToFinance = kavakFinanced ? kavakGross : 0;
                const kavakUpfront = kavakFinanced ? 0 : kavakGross;

                const maintMultiplier = maintIva ? (1 + IVA_RATE) : 1;
                const maintGross = maintAmount * maintMultiplier;
                const maintToFinance = maintFinanced ? maintGross : 0;
                const maintUpfront = maintFinanced ? 0 : maintGross;

                const insuranceMultiplier = insuranceIva ? (1 + IVA_RATE) : 1;
                const insuranceGrossYearly = MANDATORY_INSURANCE_YEARLY * insuranceMultiplier;
                const totalInsuranceForTerm = insuranceGrossYearly * (newTerm / 12); // Always financed

                const addonFinanced = kavakToFinance + maintToFinance + totalInsuranceForTerm;
                const addonUpfront = kavakUpfront + maintUpfront;
                
                // Origination fee is calculated on the loan amount *before* the origination fee itself is added.
                const principalBeforeOrig = baseLoan + serviceFeeToFinance + addonFinanced;
                const originationFeeBase = principalBeforeOrig * originationPct;
                const originationMultiplier = originationIva ? (1 + IVA_RATE) : 1;
                const originationFeeGross = originationFeeBase * originationMultiplier;
                const originationFeeToFinance = originationFinanced ? originationFeeGross : 0;
                const originationFeeUpfront = originationFinanced ? 0 : originationFeeGross;
                
                const loanNeeded = principalBeforeOrig + originationFeeToFinance;

                // Calculate new payment
                const effectiveRate = marketRate * rateMultiplier;
                const basePayment = calculateMonthlyPayment(loanNeeded, effectiveRate, newTerm);
                const gpsWithIVA = GPS_MONTHLY * (1 + IVA_RATE);
                const newTotalPayment = basePayment + gpsWithIVA;
                
                // Customer cash required
                const customerDownPayment = newPrice * downPaymentPct;
                const totalCustomerCash = customerDownPayment + serviceFeeUpfront + originationFeeUpfront + addonUpfront;
                
                // Display loan details
                document.getElementById('loanNeeded').textContent = formatCurrency(loanNeeded);
                
                if (totalCustomerCash > 0) {
                    document.getElementById('customerCashField').style.display = 'block';
                    document.getElementById('customerCashRequired').textContent = formatCurrency(totalCustomerCash);
                } else {
                    document.getElementById('customerCashField').style.display = 'none';
                }
                
                // Display new total payment (including IVA and GPS)
                document.getElementById('marketPayment').textContent = formatCurrency(newTotalPayment);
                
                // Payment change
                const paymentChange = newTotalPayment - currentTotalPayment;
                const paymentChangeEl = document.getElementById('paymentChange');
                if (paymentChange >= 0) {
                    paymentChangeEl.textContent = '+' + formatCurrency(paymentChange);
                    paymentChangeEl.style.color = '#ff4444';
                } else {
                    paymentChangeEl.textContent = formatCurrency(paymentChange);
                    paymentChangeEl.style.color = '#00ff88';
                }
                
                // NPV calculations
                const currentNPVResult = calculateNPV(currentBalance, currentRate, costOfFunds, monthsLeft, discountRate);
                const currentNPV = currentNPVResult.netMarginNPV; 

                const newNPVResult = calculateNPV(loanNeeded, marketRate, costOfFunds, newTerm, discountRate);
                const newNPV = newNPVResult.netMarginNPV;

                const valueCreated = newNPV - currentNPV; 
                
                // --- P&L and Profit Calculation REWORK (Investment Grade) ---

                // I. Operating Profit (based on pre-IVA amounts)
                const opTradingMargin = grossMargin;
                const opFeeRevenue = originationFeeBase + serviceFeeBase;
                const insuranceRevenue = MANDATORY_INSURANCE_YEARLY * (newTerm / 12); // Base revenue for profit calc
                const opAddonRevenue = kavakAmount + maintAmount + insuranceRevenue;
                const totalOperatingProfit = opTradingMargin + opFeeRevenue + opAddonRevenue;

                // II. Financing Profit (NPV)
                const financingProfitNPV = newNPVResult.netMarginNPV;

                // III. Total Deal Profit
                const totalDealProfit = totalOperatingProfit + financingProfitNPV;
                
                // --- Final Display Updates ---

                // Final results cards
                document.getElementById('finalPayment').textContent = formatCurrency(newTotalPayment);
                document.getElementById('yourProfit').textContent = formatCurrency(totalDealProfit);
                const customerSaves = currentTotalPayment - newTotalPayment;
                const custSaveEl = document.getElementById('customerSaves');
                if (customerSaves >= 0) {
                    custSaveEl.classList.remove('negative');
                    custSaveEl.classList.add('positive');
                    custSaveEl.textContent = formatCurrency(customerSaves) + '/mo';
                } else {
                    custSaveEl.classList.remove('positive');
                    custSaveEl.classList.add('negative');
                    custSaveEl.textContent = '-' + formatCurrency(Math.abs(customerSaves)) + '/mo';
                }
                document.getElementById('paymentComparison').textContent = `vs ${formatCurrency(currentTotalPayment)} current`;

                // Calculate LTV
                const historicalNPVResult = calculateNPV(originalAmount, currentRate, costOfFunds, originalTerm, discountRate);
                const historicalNPV = historicalNPVResult.netMarginNPV;
                const totalLTV = historicalNPV + totalDealProfit;
                
                // Display value creation diagram
                document.getElementById('currentNPV').textContent = formatCurrency(currentNPV);
                document.getElementById('newNPV').textContent = formatCurrency(newNPV);
                document.getElementById('valueCreated').textContent = formatCurrency(valueCreated);
                document.getElementById('valueCreatedText').textContent = formatCurrency(valueCreated);
                
                // Display LTV diagram
                document.getElementById('historicalNPV').textContent = formatCurrency(historicalNPV);
                document.getElementById('newDealNPV').textContent = formatCurrency(totalDealProfit);
                document.getElementById('totalLTV').textContent = formatCurrency(totalLTV);
                document.getElementById('ltvText').textContent = formatCurrency(totalLTV);
                
                // --- Populate the new P&L Analytics Tab ---
                // I. Operating Profit
                document.getElementById('pl_op_total').textContent = formatCurrency(totalOperatingProfit);
                document.getElementById('pl_op_trading').textContent = `+ ${formatCurrency(opTradingMargin)}`;
                document.getElementById('pl_op_fees').textContent = `+ ${formatCurrency(opFeeRevenue)}`;
                document.getElementById('pl_op_addons').textContent = `+ ${formatCurrency(opAddonRevenue)}`;
                
                // II. Financing Profit (NPV)
                document.getElementById('pl_fin_total').textContent = formatCurrency(financingProfitNPV);
                document.getElementById('pl_fin_nim').textContent = `+ ${formatCurrency(financingProfitNPV)}`;
                
                // III. Total Profit
                document.getElementById('pl_total_final').textContent = formatCurrency(totalDealProfit);
                
            } catch (error) {
                console.error('Error in calculate function:', error);
            }
        }

        // Toggle accordion sections
        function toggleAccordion(id) {
            const element = document.getElementById(id);
            if (element.style.display === 'none' || element.style.display === '') {
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
        }

        // Sync sale price with new car price
        function syncSalePrice() {
            const newPrice = parseFloat(document.getElementById('newPrice').value) || 0;
            document.getElementById('salePrice').value = newPrice;
        }
        
        // Sync new car price with sale price  
        function syncNewPrice() {
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
            document.getElementById('newPrice').value = salePrice;
        }

        // Page navigation
        function showPage(pageId) {
            console.log('showPage called for:', pageId);
            
            // Try to auto-save but don't let errors prevent tab switching
            try {
                autoSave();
            } catch (error) {
                console.log('Could not auto-save:', error.message);
            }

            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected page and activate tab
            const pageDiv = document.getElementById(pageId + 'Page');
            const tabDiv = document.getElementById(pageId + 'Tab');
            
            if (pageDiv) {
                pageDiv.classList.add('active');
                console.log('Page activated:', pageId + 'Page');
            } else {
                console.error('Page div not found for', pageId + 'Page');
            }
            
            if (tabDiv) {
                tabDiv.classList.add('active');
            }

            // Force recalculation
            calculate();

            // Update plan matrix if switching to that page
            if (pageId === 'planMatrix') {
                console.log('Updating plan matrix...');
                updatePlanMatrix();
            }

            console.log('Switched to page:', pageId);
        }

        // Export to CSV
        function exportToCSV() {
            const data = [
                ['Trade-Up Value Creation Analysis', ''],
                ['Generated', new Date().toLocaleString()],
                ['', ''],
                ['VEHICLE MARGIN', ''],
                ['Purchase Price', document.getElementById('purchasePrice').value],
                ['Sale Price', document.getElementById('salePrice').value],
                ['Gross Margin', document.getElementById('grossMargin').textContent],
                ['Margin %', document.getElementById('marginPercent').textContent],
                ['', ''],
                ['CURRENT LOAN', ''],
                ['Original Amount', document.getElementById('originalAmount').value],
                ['Current Balance', document.getElementById('currentBalance').textContent],
                ['Monthly Payment', document.getElementById('monthlyPayment').textContent],
                ['Months Left', document.getElementById('monthsLeft').value],
                ['Current Car Value', document.getElementById('currentValue').value],
                ['Customer Equity', document.getElementById('equity').textContent],
                ['', ''],
                ['NEW LOAN', ''],
                ['New Car Price', document.getElementById('newPrice').value],
                ['Loan Amount Needed', document.getElementById('loanNeeded').textContent],
                ['Market Rate', document.getElementById('marketRate').value + '%'],
                ['New Term', document.getElementById('newTerm').value + ' months'],
                ['', ''],
                ['VALUE CREATION', ''],
                ['Current NPV', document.getElementById('currentNPV').textContent],
                ['New NPV', document.getElementById('newNPV').textContent],
                ['Value Created', document.getElementById('valueCreated').textContent],
                ['Customer LTV', document.getElementById('totalLTV').textContent],
                ['', ''],
                ['FINANCIAL RESULTS', ''],
                ['New Monthly Payment', document.getElementById('finalPayment').textContent],
                ['Your Net Profit', document.getElementById('yourProfit').textContent],
                ['Customer Monthly Savings', document.getElementById('customerSaves').textContent],
                ['', ''],
                ['P&L SUMMARY', ''],
                ['Total Revenue', document.getElementById('totalRevenue').textContent],
                ['Net Profit', document.getElementById('netProfitPL').textContent],
            ];
            
            const csv = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trade-up-analysis-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Save/load functionality with error handling
        function saveData(showFeedback = true, clickEvent = null) {
            try {
                const saveData = {
                    timestamp: new Date().toISOString(),
                    purchasePrice: document.getElementById('purchasePrice').value,
                    salePrice: document.getElementById('salePrice').value,
                    originalAmount: document.getElementById('originalAmount').value,
                    originalTerm: document.getElementById('originalTerm').value,
                    currentRate: document.getElementById('currentRate').value,
                    discountRate: document.getElementById('discountRate').value,
                    monthsLeft: document.getElementById('monthsLeft').value,
                    currentValue: document.getElementById('currentValue').value,
                    baselineToggle: document.getElementById('baselineToggle').checked,
                    newPrice: document.getElementById('newPrice').value,
                    newTerm: document.getElementById('newTerm').value,
                    marketRate: document.getElementById('marketRate').value,
                    costOfFunds: document.getElementById('costOfFunds').value,
                    downPaymentToggle: document.getElementById('downPaymentToggle').checked,
                    downPaymentPct: document.getElementById('downPaymentPct').value,
                    originationPct: document.getElementById('originationPct').value,
                    servicePct: document.getElementById('servicePct').value,
                    kavakToggle: document.getElementById('kavakToggle').checked,
                    kavakAmount: document.getElementById('kavakAmount').value,
                    kavakFinance: document.getElementById('kavakFinance').checked,
                    maintToggle: document.getElementById('maintToggle').checked,
                    maintAmount: document.getElementById('maintAmount').value,
                    maintFinance: document.getElementById('maintFinance').checked,
                    ivaToggle: document.getElementById('ivaToggle').checked,
                    originationFinance: document.getElementById('originationFinance').checked,
                    serviceFinance: document.getElementById('serviceFinance').checked,
                    originationIvaToggle: document.getElementById('originationIvaToggle').checked,
                    serviceIvaToggle: document.getElementById('serviceIvaToggle').checked,
                    kavakIvaToggle: document.getElementById('kavakIvaToggle').checked,
                    maintIvaToggle: document.getElementById('maintIvaToggle').checked,
                    insuranceIvaToggle: document.getElementById('insuranceIvaToggle').checked,
                    // vehicleInsToggle: document.getElementById('vehicleInsToggle').checked, // Obsolete
                    // vehicleInsAmount: document.getElementById('vehicleInsAmount').value, // Obsolete
                    // vehicleInsFinance: document.getElementById('vehicleInsFinance').checked, // Obsolete
                    currentPage: document.querySelector('.page-content.active')?.id || 'inputsPage'
                };
                
                localStorage.setItem('tradeUpCalculatorData', JSON.stringify(saveData));
                localStorage.setItem('tradeUpCalculatorBackup', JSON.stringify(saveData));
                updateSaveStatus('Saved at ' + new Date().toLocaleTimeString());
                
                if (showFeedback && clickEvent && clickEvent.target) {
                    const button = clickEvent.target;
                    const originalText = button.textContent;
                    button.textContent = '✅ Saved!';
                    button.style.background = '#00ff88';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#00ff88';
                    }, 2000);
                }
                
                console.log('Data saved successfully:', saveData.timestamp);
            } catch (error) {
                console.log('Storage not available:', error.message);
                updateSaveStatus('Storage disabled - changes not saved');
                
                if (showFeedback && clickEvent && clickEvent.target) {
                    const button = clickEvent.target;
                    const originalText = button.textContent;
                    button.textContent = '❌ Storage disabled';
                    button.style.background = '#ff4444';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#00ff88';
                    }, 2000);
                }
            }
        }
        
        function validateAndRecoverData() {
            try {
                const mainData = localStorage.getItem('tradeUpCalculatorData');
                const backupData = localStorage.getItem('tradeUpCalculatorBackup');
                
                if (!mainData && backupData) {
                    console.log('🔄 Recovering from backup data...');
                    localStorage.setItem('tradeUpCalculatorData', backupData);
                    updateSaveStatus('Recovered from backup');
                    return true;
                }
                
                if (mainData) {
                    JSON.parse(mainData);
                    return true;
                }
                
                return false;
            } catch (error) {
                console.log('Storage not available or data corrupted:', error.message);
                updateSaveStatus('Storage disabled - using defaults');
                return false;
            }
        }
        
        function autoSave() {
            saveData(false);
        }
        
        function updateSaveStatus(status) {
            const mainStatus = document.getElementById('mainSaveStatus');
            if (mainStatus) {
                if (status.includes('error') || status.includes('failed') || status.includes('disabled')) {
                    mainStatus.style.color = '#ff4444';
                    mainStatus.style.borderColor = 'rgba(255,68,68,0.3)';
                    mainStatus.style.background = 'rgba(255,68,68,0.1)';
                } else {
                    mainStatus.style.color = '#00ff88';
                    mainStatus.style.borderColor = 'rgba(0,255,136,0.3)';
                    mainStatus.style.background = 'rgba(0,255,136,0.1)';
                }
                
                if (status.includes('Storage disabled')) {
                    mainStatus.textContent = 'Storage disabled ⚠️';
                } else if (status.includes('Auto-save disabled')) {
                    mainStatus.textContent = 'Auto-save disabled ⚠️';
                } else {
                    mainStatus.textContent = status.includes('Auto-save') ? 'Auto-save enabled ✓' : status;
                }
            }
            
            if (!status.includes('Auto-save enabled') && !status.includes('Ready')) {
                let statusElement = document.getElementById('saveStatus');
                if (!statusElement) {
                    statusElement = document.createElement('div');
                    statusElement.id = 'saveStatus';
                    statusElement.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.9); color: #00ff88; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 1000; border: 1px solid #00ff88; display: none;';
                    document.body.appendChild(statusElement);
                }
                
                statusElement.textContent = status;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }
        
        function loadSavedData() {
            try {
                if (!validateAndRecoverData()) {
                    console.log('No valid saved data found, using defaults');
                    calculate();
                    return;
                }
                
                const saved = localStorage.getItem('tradeUpCalculatorData');
                if (saved) {
                    const data = JSON.parse(saved);
                    console.log('Loading saved data from:', data.timestamp);
                    
                    Object.keys(data).forEach(key => {
                        if (key !== 'timestamp' && key !== 'currentPage') {
                            const element = document.getElementById(key);
                            if (element) {
                                if (element.type === 'checkbox') {
                                    element.checked = data[key];
                                } else if (key.startsWith('vehicleIns')) {
                                    // Do nothing for obsolete keys
                                } else {
                                    element.value = data[key];
                                }
                            }
                        }
                    });
                    
                    calculate();
                    toggleDownPayment();
                    updateSaveStatus('Data loaded from ' + new Date(data.timestamp).toLocaleString());
                }
            } catch (error) {
                console.log('Storage not available:', error.message);
                updateSaveStatus('Storage disabled - using defaults');
                calculate();
            }
        }
        
        function calculateWithAutoSave() {
            calculate();

            // If equalize switch is on, make sure all term settings match the main inputs.
            const equalizeToggle = document.getElementById('equalizeTermsToggle');
            if (equalizeToggle && equalizeToggle.checked) {
                syncAllTermsFromInputs();
            }

            // If the matrix page is currently active, we must re-render it to show changes.
            if (document.getElementById('planMatrixPage').classList.contains('active')) {
                updatePlanMatrix();
            }

            autoSave();
        }
        
        // PLAN MATRIX FUNCTIONS
        function updatePlanMatrix() {
            console.log('Updating Plan Matrix...');
            
            try {
                // Get current values
                const currentBalance = parseFloat(document.getElementById('currentBalance').textContent.replace(/[^0-9.-]+/g, '')) || 0;
                const monthlyPaymentBase = parseFloat(document.getElementById('monthlyPayment').textContent.replace(/[^0-9.-]+/g, '')) || 0;
                const currentRate = parseFloat(document.getElementById('currentRate').value) / 100 || 0;
                const monthsLeft = parseFloat(document.getElementById('monthsLeft').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) / 100 || 0;

                // Current total payment (already calculated in calculate() with baseline toggle)
                const currentTotalPay = monthlyPaymentBase;

                const equity = parseFloat(document.getElementById('equity').textContent.replace(/[^0-9.-]+/g, '')) || 0;
                const currentNPV = calculateNPV(currentBalance, currentRate, parseFloat(document.getElementById('costOfFunds').value)/100 || 0, monthsLeft, discountRate).netMarginNPV;

                const newPrice = parseFloat(document.getElementById('newPrice').value) || 0;
                const marketRate = parseFloat(document.getElementById('marketRate').value) / 100 || 0;
                const costOfFunds = parseFloat(document.getElementById('costOfFunds').value) / 100 || 0;
                const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
                const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
                const grossMargin = salePrice - purchasePrice;

                const matrixData = [];
                termsArray.forEach(term => {
                    const cfg = columnSettings[term] || {origPct:0, servicePct:0, kavak:{amount:0, finance:false}, maint:{amount:0, finance:false}, vehIns:{amount:0, finance:false}};
                    const data = calculateTermOption(term, {
                        newPrice,
                        equity,
                        downPct: downOverrides[term] || 0,
                        origPct: cfg.origPct,
                        servPct: cfg.servicePct,
                        kavak: cfg.kavak,
                        maint: cfg.maint,
                        vehIns: cfg.vehIns,
                        marketRate,
                        costOfFunds,
                        discountRate,
                        currentNPV,
                        currentTotalPay,
                        grossMargin
                    });
                    matrixData.push(data);
                });

                renderPlanMatrix(matrixData, newPrice, currentTotalPay, equity);
            } catch (error) {
                console.error('Error in updatePlanMatrix:', error);
            }
        }
        
        function calculateTermOption(term, {
            newPrice,
            equity,
            downPct,
            origPct,
            servPct,
            kavak,
            maint,
            marketRate,
            costOfFunds,
            discountRate,
            currentNPV,
            currentTotalPay,
            grossMargin
        }) {
             // Read all toggles directly from the main page for consistency
            const rateIvaOn = document.getElementById('ivaToggle').checked;
            const originationIva = document.getElementById('originationIvaToggle').checked;
            const serviceIva = document.getElementById('serviceIvaToggle').checked;
            const kavakIva = (columnSettings[term]?.kavak || {}).amount > 0 ? document.getElementById('kavakIvaToggle').checked : false;
            const maintIva = (columnSettings[term]?.maint || {}).amount > 0 ? document.getElementById('maintIvaToggle').checked : false;
            const insuranceIva = document.getElementById('insuranceIvaToggle').checked;

            const serviceFinanced = document.getElementById('serviceFinance').checked;
            const originationFinanced = document.getElementById('originationFinance').checked;

            const rateMultiplier = rateIvaOn ? (1 + IVA_RATE) : 1;
             
             let adjustedMarketRate = marketRate;
             if (term === 60) {
                adjustedMarketRate += 0.01;
             } else if (term === 72) {
                adjustedMarketRate += 0.015;
             }
             const effectiveRate = adjustedMarketRate * rateMultiplier;

            // --- Principal Components (Reworked for financing toggles) ---
            const downPaymentAmount = newPrice * downPct;
            let baseLoan = newPrice - equity - downPaymentAmount;
            if (baseLoan < 0) baseLoan = 0;

            const serviceFeeBase = newPrice * servPct;
            const serviceFeeMultiplier = serviceIva ? (1 + IVA_RATE) : 1;
            const serviceFeeGross = serviceFeeBase * serviceFeeMultiplier;
            const serviceFeeToFinance = serviceFinanced ? serviceFeeGross : 0;
            const serviceFeeUpfront = serviceFinanced ? 0 : serviceFeeGross;

            const kavakMultiplier = kavakIva ? (1 + IVA_RATE) : 1;
            const kavakGross = kavak.amount * kavakMultiplier;
            const kavakToFinance = kavak.finance ? kavakGross : 0;
            const kavakUpfront = kavak.finance ? 0 : kavakGross;
            
            const maintMultiplier = maintIva ? (1 + IVA_RATE) : 1;
            const maintGross = maint.amount * maintMultiplier;
            const maintToFinance = maint.finance ? maintGross : 0;
            const maintUpfront = maint.finance ? 0 : maintGross;

            const insuranceMultiplier = insuranceIva ? (1 + IVA_RATE) : 1;
            const insuranceGrossYearly = MANDATORY_INSURANCE_YEARLY * insuranceMultiplier;
            const totalInsuranceForTerm = insuranceGrossYearly * (term / 12);
            
            const addonFinanced = kavakToFinance + maintToFinance + totalInsuranceForTerm;
            
            const principalBeforeOrig = baseLoan + serviceFeeToFinance + addonFinanced;
            const origFeeBase = principalBeforeOrig * origPct;
            const originationMultiplier = originationIva ? (1 + IVA_RATE) : 1;
            const originationFeeGross = origFeeBase * originationMultiplier;
            const origFeeToFinance = originationFinanced ? originationFeeGross : 0;
            const originationFeeUpfront = originationFinanced ? 0 : originationFeeGross;
            
            const loanNeeded = principalBeforeOrig + origFeeToFinance;

            // --- Attributed Monthly Payments (Amortized) ---
            const vehiclePayment = calculateMonthlyPayment(baseLoan, effectiveRate, term);
            const insurancePayment = calculateMonthlyPayment(totalInsuranceForTerm, effectiveRate, term);
            const serviceFeePayment = calculateMonthlyPayment(serviceFeeToFinance, effectiveRate, term);
            const origFeePayment = calculateMonthlyPayment(origFeeToFinance, effectiveRate, term);
            const kavakPayment = calculateMonthlyPayment(kavakToFinance, effectiveRate, term);
            const maintPayment = calculateMonthlyPayment(maintToFinance, effectiveRate, term);
            const gpsWithIva = GPS_MONTHLY * (1 + IVA_RATE);

            // --- Build up Mensualidades ---
            const mensualidad1 = vehiclePayment + insurancePayment + gpsWithIva;
            const mensualidad2 = mensualidad1 + serviceFeePayment + origFeePayment;
            const totalMonthlyPayment = mensualidad2 + kavakPayment + maintPayment;

            // --- Economics & Other ---
            const newNPVResult = calculateNPV(loanNeeded, adjustedMarketRate, costOfFunds, term, discountRate);
            const valueCreated = newNPVResult.netMarginNPV - currentNPV;
            
            const insuranceRevenue = MANDATORY_INSURANCE_YEARLY * (term / 12);
            const totalOpProfit = grossMargin + origFeeBase + serviceFeeBase + kavak.amount + maint.amount + insuranceRevenue;
            const totalDealProfit = totalOpProfit + newNPVResult.netMarginNPV;
            
            const cashRequired = downPaymentAmount + serviceFeeUpfront + originationFeeUpfront + kavakUpfront + maintUpfront;
            const cashUpfrontFees = serviceFeeUpfront + originationFeeUpfront;
            const cashUpfrontAddons = kavakUpfront + maintUpfront;

            return {
                term,
                loanNeeded,
                downPaymentAmount,
                cashRequired,
                cashUpfrontFees,
                cashUpfrontAddons,
                // P&L breakdown fields
                vehiclePayment,
                insurancePayment,
                gpsMonthly: gpsWithIva,
                mensualidad1,
                serviceFeePayment,
                origFeePayment,
                mensualidad2,
                kavakPayment,
                maintPayment,
                totalMonthlyPayment,
                // Deltas for live feedback
                deltaVsMensualidad1: mensualidad1 - currentTotalPay,
                deltaVsMensualidad2: mensualidad2 - currentTotalPay,
                deltaVsCurrent: totalMonthlyPayment - currentTotalPay,
                // Other summary fields
                valueCreated,
            };
        }
        
        function renderPlanMatrix(matrixData, newPrice, currentTotalPay, equity) {
            console.log('renderPlanMatrix called, matrixData length:', matrixData?.length);
            const tbody = document.getElementById('planMatrixBody');
            if (!tbody) { 
                console.error('planMatrixBody element not found'); 
                return; 
            }
            tbody.innerHTML = '';

            const currentTerm = parseInt(document.getElementById('newTerm').value);

            // Helper to build a row
            const buildRow = (label, contentFn, isEditable = false, isIndented = false, isHeader = false) => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #222';
                 if (isHeader) {
                    tr.style.background = '#0d1117';
                    tr.style.fontWeight = 'bold';
                }
                
                const th = document.createElement('td');
                th.textContent = label;
                th.style.cssText = `padding:10px; position:sticky; left:0; background:${isHeader ? '#0d1117' : '#0a0a0a'}; border-right:1px solid #333; font-weight:600; font-size:13px; ${isIndented ? 'padding-left: 25px; color: #bbb;' : ''}`;
                tr.appendChild(th);
                
                matrixData.forEach((col, idx) => {
                    const td = document.createElement('td');
                    td.style.cssText = 'padding:8px; text-align:center; border-right:1px solid #222; font-size:13px;';
                    
                    // Apply highlighting for current term
                    if (col.term === currentTerm) {
                        td.classList.add('current-term-col');
                    }
                    
                    td.innerHTML = contentFn(col, idx);
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            };

            // --- RENDER ALL ROWS BASED ON CONFIG ---
            const renderFunctions = {
                // Added per user request
                newCarPrice: () => buildRow(matrixViewConfig.newCarPrice.label, (col) => `<strong>${formatCurrency(newPrice)}</strong>`),
                enganche: () => buildRow(matrixViewConfig.enganche.label, (col) => `<strong>${formatCurrency(equity)}</strong>`),
                
                // Editable
                downPaymentPct: () => buildRow(matrixViewConfig.downPaymentPct.label, (col) => {
                const pct = (downOverrides[col.term] || 0) * 100;
                    return `<input type="number" value="${pct.toFixed(1)}" min="0" max="50" step="0.1" class="matrix-input" onchange="handleMatrixEdit(${col.term},'downPct',this.value)">`;
                }, true),
                downPaymentAmount: () => buildRow(matrixViewConfig.downPaymentAmount.label, (col) => formatCurrency(col.downPaymentAmount)),
                cashRequiredTotal: () => buildRow(matrixViewConfig.cashRequiredTotal.label, (col) => `<strong>${formatCurrency(col.cashRequired)}</strong>`, false, false, true),
                cashRequiredDownPayment: () => buildRow(matrixViewConfig.cashRequiredDownPayment.label, (col) => formatCurrency(col.downPaymentAmount), false, true),
                cashRequiredFees: () => buildRow(matrixViewConfig.cashRequiredFees.label, (col) => formatCurrency(col.cashUpfrontFees), false, true),
                cashRequiredAddons: () => buildRow(matrixViewConfig.cashRequiredAddons.label, (col) => formatCurrency(col.cashUpfrontAddons), false, true),
                loanAmount: () => buildRow(matrixViewConfig.loanAmount.label, (col) => `<strong>${formatCurrency(col.loanNeeded)}</strong>`, false, false, true),

                originationFeePct: () => buildRow(matrixViewConfig.originationFeePct.label, (col) => {
                const pct = (columnSettings[col.term]?.origPct || 0) * 100;
                    return `<input type="number" value="${pct.toFixed(1)}" min="0" max="20" step="0.1" class="matrix-input" onchange="handleMatrixEdit(${col.term},'origPct',this.value)">`;
                }, true),
                serviceFeePct: () => buildRow(matrixViewConfig.serviceFeePct.label, (col) => {
                const pct = (columnSettings[col.term]?.servicePct || 0) * 100;
                    return `<input type="number" value="${pct.toFixed(1)}" min="0" max="20" step="0.1" class="matrix-input" onchange="handleMatrixEdit(${col.term},'servicePct',this.value)">`;
                }, true),
                kavak: () => buildRow(matrixViewConfig.kavak.label, (col) => {
                    const obj = columnSettings[col.term]?.kavak || {amount:0, finance:false};
                    return `<input type="number" value="${obj.amount}" min="0" step="50" class="matrix-input" onchange="handleMatrixEdit(${col.term},'kavak',this.value,'amount')"><br><input type="checkbox" ${obj.finance?'checked':''} class="matrix-checkbox" onchange="handleMatrixEdit(${col.term},'kavak',this.checked,'finance')"><span style="font-size:11px;">Finance</span>`;
                }, true),
                maint: () => buildRow(matrixViewConfig.maint.label, (col) => {
                    const obj = columnSettings[col.term]?.maint || {amount:0, finance:false};
                    return `<input type="number" value="${obj.amount}" min="0" step="50" class="matrix-input" onchange="handleMatrixEdit(${col.term},'maint',this.value,'amount')"><br><input type="checkbox" ${obj.finance?'checked':''} class="matrix-checkbox" onchange="handleMatrixEdit(${col.term},'maint',this.checked,'finance')"><span style="font-size:11px;">Finance</span>`;
                }, true),
                // P&L Breakdown
                vehiclePayment: () => buildRow(matrixViewConfig.vehiclePayment.label, (col) => formatCurrency(col.vehiclePayment), false, false, true),
                insurancePayment: () => buildRow(matrixViewConfig.insurancePayment.label, (col) => formatCurrency(col.insurancePayment), false, true),
                gpsMonthly: () => buildRow(matrixViewConfig.gpsMonthly.label, (col) => formatCurrency(col.gpsMonthly), false, true),
                mensualidad1: () => buildRow(matrixViewConfig.mensualidad1.label, (col) => {
                    const delta = col.deltaVsMensualidad1;
                    const color = delta > 0 ? '#ff4444' : '#00ff88';
                    const sign = delta >= 0 ? '+' : '';
                    return `<strong>${formatCurrency(col.mensualidad1)}</strong><br><span style="font-size:11px; color:${color};">(${sign}${formatCurrency(delta)})</span>`;
                }),
                serviceFeePayment: () => buildRow(matrixViewConfig.serviceFeePayment.label, (col) => formatCurrency(col.serviceFeePayment), false, true),
                origFeePayment: () => buildRow(matrixViewConfig.origFeePayment.label, (col) => formatCurrency(col.origFeePayment), false, true),
                mensualidad2: () => buildRow(matrixViewConfig.mensualidad2.label, (col) => {
                    const delta = col.deltaVsMensualidad2;
                    const color = delta > 0 ? '#ff4444' : '#00ff88';
                    const sign = delta >= 0 ? '+' : '';
                    return `<strong>${formatCurrency(col.mensualidad2)}</strong><br><span style="font-size:11px; color:${color};">(${sign}${formatCurrency(delta)})</span>`;
                }),
                kavakPayment: () => buildRow(matrixViewConfig.kavakPayment.label, (col) => formatCurrency(col.kavakPayment), false, true),
                maintPayment: () => buildRow(matrixViewConfig.maintPayment.label, (col) => formatCurrency(col.maintPayment), false, true),
                totalMonthlyPayment: () => buildRow(matrixViewConfig.totalMonthlyPayment.label, (col) => {
                    const delta = col.deltaVsCurrent;
                    const color = delta > 0 ? '#ff4444' : '#00ff88';
                    const sign = delta >= 0 ? '+' : '';
                    return `<strong>${formatCurrency(col.totalMonthlyPayment)}</strong><br><span style="font-size:11px; color:${color};">(${sign}${formatCurrency(delta)})</span>`;
                }),

                // Summary
                npvCreated: () => buildRow(matrixViewConfig.npvCreated.label, (col) => formatCurrency(col.valueCreated)),
            };
            
            matrixRowOrder.forEach(key => {
                if (matrixViewConfig[key].visible && renderFunctions[key]) {
                    renderFunctions[key]();
                }
            });
        }
        
        function applyMatrixView(preset) {
            const isClient = preset === 'client';
            Object.keys(matrixViewConfig).forEach(key => {
                matrixViewConfig[key].visible = isClient ? clientViewRows.includes(key) : true;
            });
            
            // Update button styles
            document.getElementById('clientViewBtn').classList.toggle('active', isClient);
            document.getElementById('defaultViewBtn').classList.toggle('active', !isClient);

            updatePlanMatrix();
            const panel = document.getElementById('matrixConfigPanel');
            if (panel.style.display === 'block') {
                populateMatrixConfig();
            }
        }

        function toggleMatrixConfig() {
            const panel = document.getElementById('matrixConfigPanel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                populateMatrixConfig();
            } else {
                panel.style.display = 'none';
            }
        }
        
        function populateMatrixConfig() {
            const grid = document.getElementById('matrixConfigGrid');
            grid.innerHTML = '';
            matrixRowOrder.forEach(key => {
                const config = matrixViewConfig[key];
                const item = document.createElement('div');
                item.className = 'matrix-config-item';
                item.innerHTML = `
                    <input type="checkbox" id="config_${key}" ${config.visible ? 'checked' : ''} onchange="toggleMatrixRowVisibility('${key}')">
                    <label for="config_${key}">${config.label}</label>
                `;
                grid.appendChild(item);
            });
        }

        function toggleMatrixRowVisibility(key) {
            matrixViewConfig[key].visible = !matrixViewConfig[key].visible;
            // Re-render the matrix with the new visibility settings
            updatePlanMatrix();
            // Deselect preset buttons if a custom view is made
            document.getElementById('clientViewBtn').classList.remove('active');
            document.getElementById('defaultViewBtn').classList.remove('active');
        }
        
        // Handle edits from Plan Matrix
        function handleMatrixEdit(term, category, value, subkey = null) {
            const isEqualizeOn = document.getElementById('equalizeTermsToggle').checked;
            const termsToUpdate = isEqualizeOn ? termsArray : [term];

            termsToUpdate.forEach(t => {
                if (!columnSettings[t]) {
                     columnSettings[t] = {
                    origPct: 0, 
                    servicePct: 0, 
                    kavak: {amount:0, finance:false}, 
                    maint: {amount:0, finance:false}, 
                };
            }

            switch(category) {
                case 'downPct':
                        downOverrides[t] = isNaN(value) || value === '' ? 0 : parseFloat(value) / 100;
                    break;
                case 'origPct':
                case 'servicePct':
                        columnSettings[t][category] = isNaN(value) || value === '' ? 0 : parseFloat(value) / 100;
                    break;
                case 'kavak':
                case 'maint':
                        if (!columnSettings[t][category]) {
                            columnSettings[t][category] = {amount:0, finance:false};
                    }
                    if (subkey === 'amount') {
                            columnSettings[t][category].amount = isNaN(value) || value === '' ? 0 : parseFloat(value);
                    } else if (subkey === 'finance') {
                            columnSettings[t][category].finance = !!value;
                    }
                    break;
            }
            });

            // Sync changes back to Deal Inputs if the edited term is the active one
            syncToInputs(term);
            
            // Re-render matrix
            updatePlanMatrix();
        }
        
        // Check if localStorage is available
        function isStorageAvailable() {
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch {
                return false;
            }
        }
        
        // Initialize the calculator when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Trade-Up Calculator...');
            
            // Load saved data and calculate
            loadSavedData();
            
            // Initialize per-term settings from current inputs
            syncFromInputs();
            
            // Set up periodic auto-save (every 30 seconds) with error handling
            setInterval(function() {
                try {
                    autoSave();
                } catch (error) {
                    console.log('Periodic auto-save failed:', error.message);
                }
            }, 30000);
            
            // Save data when page is about to be unloaded
            window.addEventListener('beforeunload', function() {
                try {
                    autoSave();
                    console.log('💾 Auto-saved before page unload');
                } catch (error) {
                    console.log('Could not save before unload:', error.message);
                }
            });
            
            // Save data when page loses focus
            window.addEventListener('blur', function() {
                try {
                    autoSave();
                    console.log('💾 Auto-saved on focus loss');
                } catch (error) {
                    console.log('Could not save on blur:', error.message);
                }
            });
            
            // Save on any click
            document.addEventListener('click', function() {
                setTimeout(function() {
                    try {
                        autoSave();
                    } catch (error) {
                        console.log('Could not auto-save on click:', error.message);
                    }
                }, 100);
            });
            
            console.log('✅ Calculator initialized successfully');
            updateSaveStatus('Ready - Auto-save ' + (isStorageAvailable() ? 'enabled' : 'disabled'));
        });

        // --- Plan Matrix Synchronization Logic ---

        function syncAllTermsFromInputs() {
            const baseOrigPct = parseFloat(document.getElementById('originationPct').value) / 100 || 0;
            const baseServPct = parseFloat(document.getElementById('servicePct').value) / 100 || 0;
            const baseDownPct = (document.getElementById('downPaymentToggle').checked ? parseFloat(document.getElementById('downPaymentPct').value) : 0) / 100 || 0;

            const kavakToggle = document.getElementById('kavakToggle').checked;
            const maintToggle = document.getElementById('maintToggle').checked;

            const kavakAmt = kavakToggle ? (parseFloat(document.getElementById('kavakAmount').value) || 0) : 0;
            const maintAmt = maintToggle ? (parseFloat(document.getElementById('maintAmount').value) || 0) : 0;

            const kavakFin = kavakToggle && document.getElementById('kavakFinance').checked;
            const maintFin = maintToggle && document.getElementById('maintFinance').checked;

            termsArray.forEach(term => {
                downOverrides[term] = baseDownPct;
                columnSettings[term] = {
                    origPct: baseOrigPct,
                    servicePct: baseServPct,
                    kavak: { amount: kavakAmt, finance: kavakFin },
                    maint: { amount: maintAmt, finance: maintFin },
                };
            });
        }

        function handleEqualizeToggle(isChecked) {
            if (isChecked) {
                syncAllTermsFromInputs();
                updatePlanMatrix();
            }
        }
    </script>
</body>
</html>